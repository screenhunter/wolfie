{"version":3,"sources":["/home/havvy/tennu/tennu/src/plugin/user.sjs"],"names":["Promise","require","module","exports","init","client","imports","isIdentifiedAs","nickname","accountname","debug","toLowerCase","resolve","reject","timeout","setTimeout","unregister","error","Error","fornick","fn","reply","off","handlers","clearTimeout","result","onLoggedIn","identifiedas","onRegNick","onWhoisEnd","onError","on","setImmediate","whois"],"mappings":"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","file":"user.js","sourcesContent":["const Promise = require('bluebird');\n\nmodule.exports = {\n    init: function (client, imports) {\n        const isIdentifiedAs = function(nickname, accountname) {\n            client.debug(\"PluginUser\", \"isIdentifiedAs called\");\n            nickname = nickname.toLowerCase();\n            accountname = accountname.toLowerCase();\n\n            return new Promise(function (resolve, reject) {\n                const timeout = setTimeout(function () {\n                    unregister();\n                    client.error(\"PluginUser\", \"isIdentifiedAs request timed out after one hour.\");\n                    reject(new Error(\"Request timed out.\"));\n                }, 1000 * 60 * 60);\n\n                const fornick = function (fn) {\n                    return function (reply) {\n                        if (reply.nickname.toLowerCase() === nickname) {\n                            fn(reply);\n                        } else {\n                            client.debug(\"PluginUser\", \"Whois response for another nick: \" + reply.nickname);\n                        }\n                    }\n                };\n\n                const unregister = function () {\n                    client.debug('PluginUser', 'Unregistering isIdentifiedAs handlers.');\n                    client.off(handlers);\n                    clearTimeout(timeout)\n                }\n\n                var result = false; // Until proven otherwise.\n\n                const onLoggedIn = fornick(function (reply) {\n                    if (reply.identifiedas.toLowerCase() === accountname) {\n                        client.debug('PluginUser', \"isIdentifiedAs found a match.\");\n                        result = true;\n                    }\n                });\n\n                const onRegNick = fornick(function (reply) {\n                    if (nickname === accountname) {\n                        client.debug('PluginUser', \"isIdentifiedAs found a match.\");\n                        result = true;\n                    }\n                });\n\n                const onWhoisEnd = fornick(function (reply) {\n                    client.debug('PluginUser', \"isIdentifiedAs found end of whois.\");\n                    unregister();\n                    client.debug('PluginUser', \"Resolving \" + result);\n                    resolve(result)\n                });\n\n                const onError = fornick(function (reply) {\n                    unregister();\n                    resolve(false);\n                });\n\n                const handlers = {\n                    \"rpl_whoisregnick\": onRegNick,\n                    \"rpl_whoisloggedin\": onLoggedIn,\n                    \"rpl_endofwhois\": onWhoisEnd,\n                    \"err_nosuchnick\": onError\n                };\n\n                client.debug('Registering isIdentifiedAs handlers');\n                client.on(handlers);\n                setImmediate(function () { client.whois(nickname) });\n            });\n        };\n\n        return {\n            exports: {\n                isIdentifiedAs: isIdentifiedAs\n            }\n        };\n    }\n};"],"sourceRoot":"/source/"}